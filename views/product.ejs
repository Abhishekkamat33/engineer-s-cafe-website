<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu</title>
</head>
<link rel="stylesheet" href="/stylesheets/product.css">
<body>
 <div class="header">
  <input  id="text" type="text"  name="menu search" placeholder="search  your food">
  <button id="submit" >submit</button>
  <div class="link">
  <a href="#popular">popular</a>
  <a href="/profile">home</a>
  </div>

  <div class="cart">
   
  <a id="orderLink" href="order"> <img data-index="1" id="cartimg" class="cart"src="data:image/png;base64,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" alt="">
  <span id="value">0</span>
</a>
</div>
 </div>
<div class="card">
 <div class="heading">popular:</div>
 <div id="popular">
  <% var popularJson = null; %>
  <% popularJson = JSON.stringify(popular); %>
  <% popular.forEach(function(popular,index) { %>
     <div class="menu">
         <img src="/images/<%=popular.image %>" alt="<%= popular.name %>">
         <h2><%= popular.name %></h2>
         <p class="details"><%= popular.description %></p>
         <div class="btn">
         <p class="price">Price: &#8377;<%= popular.price.toFixed(2) %></p>
         <button data-index="<%= index  %>"  class="buy" id="popularproduct"   data-unit-price="<%= popular.price %>" data-popular-id="<%= popular._id %>">Buy</button>
        </div>
         <p>Category: <%= popular.category %></p>
     </div>
 <% }); %> 
</div>
<div class="heading">GENERAL:</div>
 <div id="menuItems">
   
  <% var productJson = null; %>
 <% productJson = JSON.stringify(product); %>
  
  <% product.forEach(function(product, index) { %>
      <div class="menu">
          <img src="/images/<%=product.image %>" alt="<%= product.name %>">
          <h2><%= product.name %></h2>
          <p class="details"><%= product.description %></p>
          <div class="btn">
              <p class="price">Price: &#8377;<%= product.price.toFixed(2) %></p>
              <div class="btn">
              <button data-index="<%= index  %>" class="buy" id="product" data-product-id="<%= product._id %>">Buy</button>
            </div>
          </div>
          <p>Category: <%= product.category %></p>
      </div>
  <% }); %>
</div> 
</div>
<div class="individual">
    <div class="product"></div>
    <div class="related-products">
        <!-- Related product items will be added here -->
    </div>
</div>

<footer class="footer">
    <div class="footer-container">
        <div class="footer-logo">
            <img src="https://previews.123rf.com/images/gepeng/gepeng1612/gepeng161200114/68896687-indian-food-logo-vector-illustration.jpg" alt="Food Logo">
        </div>
        <div class="display">
        <div class="footer-links">
            <ul>
                <li><a href="#">Home</a></li>
                <li><a href="#">Menu</a></li>
                <li><a href="#">About Us</a></li>
                <li><a href="#">Contact</a></li>
            </ul>
        </div>
        <div class="footer-social">
            <ul>
                <li><a href="#"><img class="icon" src="https://i.pinimg.com/564x/ec/81/69/ec8169fec55371f6824b8a0f3725c4b2.jpg"></img></a></li>
                <li><a href="#"><img class="icon" src="https://admin.itsnicethat.com/images/AdihJKT4fXnuV0w24xhusry98yA=/82604/format-webp%7Cwidth-1440/4fd07cea5c3e3c0d810000db.jpg"></img></a></li>
                <li><a href="#"><img class="icon" src="https://i.pinimg.com/originals/8f/8f/b4/8f8fb43ce828a22c91c0b59f55fb91b3.png"></img></a></li>
            </ul>
        </div>
    </div>
    </div>
    <div class="footer-bottom">
        <p>&copy; 2024 Food Website. All rights reserved.</p>
    </div>
</footer>
</body>
<script src="https://khalti.com/static/khalti-checkout.js"></script>

<script>
   
const productCounts = new Map();
let count = 0;
  let value = document.querySelector("#value"); 
  
  function decodeHtml(html) {
    var txt = document.createElement("textarea");
    txt.innerHTML = html;
    return txt.value;
  }
  
  // Decode HTML entities in the productJson
  var decodedProductJson = decodeHtml(`<%= productJson %>`);
  var decodedPopularJson = decodeHtml(`<%= popularJson %>`)
  // Parse the decoded JSON string
  var products = JSON.parse(decodedProductJson);
  var popular = JSON.parse(decodedPopularJson);
 
  // Reset count to 0 when the page loads
  window.onload = function() {
      count = 0;
  };
 

// Define addToCart function
document.addEventListener('click', function(event) {
    if (event.target && event.target.classList.contains('buy')) {
        
        if (event.target.id === 'product') {
            console.log(product);
            var product = products[event.target.dataset.index];
            addToCart(product);
            if (!productCounts.has(product._id)) {
                productCounts.set(product._id, 1);
                // addToOrderBook(product);
            }
    }
}
});
   // Event listener for clicks on buttons with id 'popularproduct'
// Event listener for clicks on buttons with id 'popularproduct'
document.addEventListener('click', function(event) {
    if (event.target.id === 'popularproduct') {
        // Retrieve the corresponding popular item using dataset index
        const index = event.target.dataset.index;
        const popularItem = popular[index]; // Assuming 'popular' is properly initialized

        // Check if popularItem is defined before further processing
        if (popularItem) {
            
            // Call addToCart function to add the popular item to the cart
            addToCart(popularItem);

            // Check if the popular item is already in the cart
            if (!productCounts.has(popularItem._id)) {
                // If not, add it to the cart and order book
                productCounts.set(popularItem._id, 1);
                // addToOrderBook(popularItem);
            }
        } else {
            console.error('Popular item is undefined.');
        }
    }
});


// Function to handle clicks on a product or popular item
function addToCart(productId) {
    // Check if the product ID is already in the map
    if (productCounts.has(productId)) {
        // If the product ID is already in the map, do not increment the count
        alert("Product already added to cart"); 
        console.log("Product already in cart. Count not incremented.");
    } else  {
        // If the product ID is not in the map, add it with a count of 1
        productCounts.set(productId, 1);
        count++;
        value.style.display = "block";
        value.innerHTML = count;
        alert("Product added to cart");
    } 
}


document.addEventListener('click', function(event) {
    var searchbtn = document.getElementById("submit");
    var search = document.getElementById('text');

    if (searchbtn && search) {
        if (event.target === searchbtn) {
            var inputValue = (search.value || '').trim().toLowerCase();
            console.log("Input value:", inputValue); // Debugging

            if (Array.isArray(products) && products.length > 0 && Array.isArray(popular) && popular.length > 0) {
                const popularProduct = popular.find(product => product.name.toLowerCase() === inputValue);
                const product = products.find(product => product.name.toLowerCase() === inputValue);

                if (popularProduct) {
                    displayProductDetails(popularProduct);
                } else if (product) {
                    displayProductDetails(product);
                } else {
                    console.log("Input value does not match any product.");
                }
            } else {
                console.log("No products or popular items found.");
            }
        }
    } else {
        console.log("Search button or input field not found.");
    }
});

function displayProductDetails(product) {
    document.querySelector(".individual").style.display = "block";
    const individual = document.querySelector('.product');
    individual.innerHTML = `
        <div class="product">
            <img class="productimg" src="${product.image_url}" alt="${product.name}">
            <h1 class="product-title">${product.name}</h1>
            <p class="product-description">${product.description}</p>
            <p class="product-price">${product.price}</p>
            <button class="add-to-cart" onclick="addtocart('${product._id}')">Add to Cart</button>
        </div>
    `;

    const relatedFood = products.filter(p => p.category === product.category && p.name !== product.name);
    const relatedpopularFood = popular.filter(p => p.category === product.category && p.name !== product.name);
    console.log("Related Food:", relatedFood); // Debugging
    console.log("Related Food:", relatedpopularFood);
    if (relatedFood.length > 0) {
        individual.innerHTML += '<h2>Related Food</h2>';
    relatedFood.forEach(product => {
        individual.innerHTML += `
            <div class="related-product">
                <img src="${product.image_url}" alt="${product.name}">
            <h1 class="product-title">${product.name}</h1>
            <p class="product-description">${product.description}</p>
            <p class="product-price">${product.price}</p>
            <button class="add-to-cart" onclick="addtocart('${product._id}')">Add to Cart</button>
            </div>
        `;
    });
} else if (relatedpopularFood.length > 0) {
    individual.innerHTML += '<h2>Related Food</h2>';
    relatedpopularFood.forEach(food => {
        individual.innerHTML += `
            <div class="related-product">
                <img  class ="related-foodimg"src="${food.image_url}" alt="${food.name}">
                <h3 class="related-product-title">${food.name}</h3>
                <p class="related-product-price">${food.price}</p>
                <button class="add-to-cart" onclick="addtocart('${food._id}')">Add to Cart</button>
            </div>
        `;
    });
} else {
    individual.innerHTML += '<p>No related food available</p>';
}

    }


function addtocart(productId) {
    console.log("Attempting to add product with ID:", productId);
    const product = products.find(p => p._id === productId);
    const popularProduct = popular.find(p => p._id === productId);

    if (product) {
        console.log("Product added to cart:", product);
        if (productCounts.has(productId)) {
        // If the product ID is already in the map, do not increment the count
        console.log("Product already in cart. Count not incremented.");
    } else {
        // If the product ID is not in the map, add it with a count of 1
        productCounts.set(productId, 1);
        count++;
        value.style.display = "block";
        value.innerHTML = count;
        console.log("Product added to cart. Count incremented.");
        addToOrderBook(product);
    }

        } else if (popularProduct) {
    console.log("Popular product added to cart:", popularProduct);
    if (productCounts.has(popularProduct._id)) {
        // If the product ID is already in the map, do not increment the count
        alert("Product already in cart. Count not incremented.");
    } else {
        // If the product ID is not in the map, add it with a count of 1
        productCounts.set(popularProduct._id, 1);
        count++;
        value.style.display = "block";
        value.innerHTML = count;
        alert("Product added to cart. Count incremented.");
        addToOrderBook(popularProduct);
    }
    } else {
        console.error("Product not found for ID:", productId);
        console.log("Products Array:", products);
    }
}

// Initialize an empty array to store product IDs
// Initialize an empty array to store product IDs
let productArray = [];

// Function to add product ID to the array if it doesn't already exist
function addToProductArray(productId) {
  // Check if the product ID already exists in the array
  if (!productArray.includes(productId)) {
    // If not, add it to the array
    productArray.push(productId);
    console.log(productArray);
  }
}

// Event listener for when the DOM is fully loaded
document.addEventListener('DOMContentLoaded', function() {
  // Select all "Buy" buttons
  const buyButtons = document.querySelectorAll('.buy');

  // Loop through each "Buy" button
  buyButtons.forEach(button => {
    // Add click event listener to each button
    button.addEventListener('click', function() {
      // Check if this is a popular product button or a regular product button
      if (this.id === "popularproduct") {
        // Get the product ID from the button's data-popular-id attribute
        const productId = this.dataset.popularId;
        // Call function to add product ID to the array
        addToProductArray(productId);
      } else if (this.id === "product") {
        // Get the product ID from the button's data-product-id attribute
        const productId = this.dataset.productId;
        // Call function to add product ID to the array
        addToProductArray(productId);
      }
      
      // Store the updated productArray in sessionStorage
      sessionStorage.setItem('productArray', JSON.stringify(productArray));

      // Construct the URL with the productArray query parameter
      const orderUrl = '/order?productArray=' + encodeURIComponent(JSON.stringify(productArray));

      // Set the href attribute of the anchor tag
      document.getElementById('orderLink').setAttribute('href', orderUrl);
    });
  });

  // Retrieve the productArray from sessionStorage if available
  const storedProductArray = sessionStorage.getItem('productArray');
  if (storedProductArray) {
    productArray = JSON.parse(storedProductArray);
  }
});


</script>  

</html>

